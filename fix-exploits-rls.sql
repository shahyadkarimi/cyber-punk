-- Fix RLS policies for exploits table to allow public access to verified exploits
ALTER TABLE public.exploits ENABLE ROW LEVEL SECURITY;

-- Drop existing policies if they're causing issues
DROP POLICY IF EXISTS "Anyone can view verified exploits" ON public.exploits;

-- Create a new policy that allows anyone to view verified exploits
CREATE POLICY "Anyone can view verified exploits" 
ON public.exploits
FOR SELECT 
USING (is_verified = TRUE);

-- Ensure the authenticated users can manage their own exploits
DROP POLICY IF EXISTS "Users can manage their own exploits" ON public.exploits;
CREATE POLICY "Users can manage their own exploits" 
ON public.exploits
USING (auth.uid() = author_id);

-- Ensure admins can manage all exploits
DROP POLICY IF EXISTS "Admins can manage all exploits" ON public.exploits;
CREATE POLICY "Admins can manage all exploits" 
ON public.exploits
USING (
    EXISTS (
        SELECT 1 FROM public.users 
        WHERE id = auth.uid() AND role = 'admin'
    )
);
